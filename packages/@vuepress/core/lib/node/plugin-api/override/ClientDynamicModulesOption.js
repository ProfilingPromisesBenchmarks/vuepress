'use strict'

/**
 * Module dependencies.
 */

const AsyncOption = require('../abstract/AsyncOption')
const { performance } = require('perf_hooks');

/**
 * clientDynamicModules option.
 */

module.exports = class ClientDynamicModulesOption extends AsyncOption {
  async apply (ctx) {
    await super.asyncApply()
    const b = performance.now();
    const promises = [];
    for (const { value, name: pluginName } of this.appliedItems) {
      const { name, content, dirname = 'dynamic' } = value
      promises.push(ctx.writeTemp(
        `${dirname}/${name}`,
        `
/**
 * Generated by "${pluginName}"
 */
${content}\n\n
        `.trim()))
    }
    await Promise.all(promises);
    const a = performance.now();
    console.log('loop in apply: ' + (a - b));
  }
}
